{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/smith-xyz/golang-fbom-generator/schemas/fbom-v0.1.0.json",
  "title": "Function Bill of Materials (FBOM) Schema",
  "description": "JSON Schema for validating Function Bill of Materials documents generated by golang-fbom-generator",
  "type": "object",
  "required": [
    "fbom_version",
    "spdx_id", 
    "creation_info",
    "package_info",
    "functions",
    "dependencies",
    "dependency_clusters",
    "entry_points",
    "call_graph",
    "security_info"
  ],
  "properties": {
    "fbom_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Version of the FBOM specification (semantic versioning)"
    },
    "spdx_id": {
      "type": "string",
      "pattern": "^SPDXRef-[A-Za-z0-9.-]+$",
      "description": "SPDX identifier for the root document"
    },
    "creation_info": {
      "type": "object",
      "required": ["created", "created_by", "tool_name", "tool_version", "creators", "license_list_id"],
      "properties": {
        "created": {
          "type": "string",
          "pattern": "^\\d+$",
          "description": "Unix timestamp of document creation"
        },
        "created_by": {
          "type": "string",
          "description": "Description of the creating tool"
        },
        "tool_name": {
          "type": "string",
          "description": "Name of the generator tool"
        },
        "tool_version": {
          "type": "string",
          "description": "Version of the generator tool"
        },
        "creators": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of document creators"
        },
        "license_list_id": {
          "type": "string",
          "description": "License identifier"
        }
      }
    },
    "package_info": {
      "type": "object",
      "required": ["name", "spdx_id", "source_info"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the analyzed package"
        },
        "spdx_id": {
          "type": "string",
          "pattern": "^SPDXRef-Package-[A-Za-z0-9.-]+$",
          "description": "SPDX identifier for the package"
        },
        "source_info": {
          "type": "string",
          "description": "Description of the package source"
        }
      }
    },
    "functions": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/function"
      },
      "description": "Array of user-defined functions"
    },
    "dependencies": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/dependency"
      },
      "description": "Array of external dependencies"
    },
    "dependency_clusters": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/dependency_cluster"
      },
      "description": "Array of dependency clusters for attack surface analysis"
    },
    "entry_points": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/entry_point"
      },
      "description": "Array of application entry points"
    },
    "call_graph": {
      "$ref": "#/$defs/call_graph",
      "description": "Call graph representation"
    },
    "reflection_analysis": {
      "$ref": "#/$defs/reflection_analysis",
      "description": "Advanced reflection analysis with user-focused vulnerability mapping"
    },
    "security_info": {
      "$ref": "#/$defs/security_info",
      "description": "Security analysis summary"
    }
  },
  "additionalProperties": true,
  "$defs": {
    "function": {
      "type": "object",
      "required": [
        "spdx_id",
        "name",
        "full_name", 
        "package",
        "file_path",
        "start_line",
        "end_line",
        "signature",
        "visibility",
        "function_type",
        "is_exported",
        "parameters",
        "return_types",
        "usage_info"
      ],
      "properties": {
        "spdx_id": {
          "type": "string",
          "pattern": "^SPDXRef-Function-[A-Za-z0-9.-]+$"
        },
        "name": {
          "type": "string"
        },
        "full_name": {
          "type": "string"
        },
        "package": {
          "type": "string"
        },
        "file_path": {
          "type": "string"
        },
        "start_line": {
          "type": "integer",
          "minimum": 1
        },
        "end_line": {
          "type": "integer",
          "minimum": 1
        },
        "signature": {
          "type": "string"
        },
        "visibility": {
          "type": "string",
          "enum": ["public", "private"]
        },
        "function_type": {
          "type": "string",
          "enum": ["main", "init", "regular", "method", "closure"]
        },
        "is_exported": {
          "type": "boolean"
        },
        "parameters": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/parameter"
          }
        },
        "return_types": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "usage_info": {
          "$ref": "#/$defs/usage_info"
        }
      }
    },
    "parameter": {
      "type": "object",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string"
        },
        "type": {
          "type": "string"
        }
      }
    },
    "usage_info": {
      "type": "object",
      "required": [
        "calls",
        "called_by",
        "external_calls",
        "stdlib_calls",
        "has_reflection_access",
        "is_reachable",
        "call_depth",
        "is_entry_point"
      ],
      "properties": {
        "calls": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "called_by": {
          "type": "array", 
          "items": {
            "type": "string"
          }
        },
        "external_calls": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "stdlib_calls": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "has_reflection_access": {
          "type": "boolean"
        },
        "is_reachable": {
          "type": "boolean"
        },
        "call_depth": {
          "type": "integer",
          "minimum": 0
        },
        "is_entry_point": {
          "type": "boolean"
        }
      }
    },
    "dependency": {
      "type": "object",
      "required": ["name", "version", "type", "spdx_id", "package_manager", "purl_identifier", "used_functions", "called_functions"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Dependency package name"
        },
        "version": {
          "type": "string",
          "description": "Package version"
        },
        "type": {
          "type": "string",
          "description": "Package type (e.g., go-module)"
        },
        "spdx_id": {
          "type": "string",
          "pattern": "^SPDXRef-[A-Za-z0-9.-]+$",
          "description": "SPDX identifier for this dependency"
        },
        "package_manager": {
          "type": "string",
          "description": "Package manager (e.g., go-modules)"
        },
        "purl_identifier": {
          "type": "string",
          "pattern": "^pkg:[^/]+/.*",
          "description": "Package URL (PURL) identifier"
        },
        "used_functions": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of functions used from this dependency"
        },
        "called_functions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/external_function_call"
          }
        },
        "fbom_reference": {
          "$ref": "#/$defs/fbom_reference"
        }
      }
    },
    "external_function_call": {
      "type": "object", 
      "required": ["function_name", "full_function_name", "call_context", "call_sites"],
      "properties": {
        "function_name": {
          "type": "string"
        },
        "full_function_name": {
          "type": "string"
        },
        "call_context": {
          "type": "string",
          "enum": ["direct", "callback", "indirect"]
        },
        "call_sites": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "fbom_reference": {
      "type": "object",
      "required": ["fbom_location", "fbom_version", "resolution_type", "spdx_document_id"],
      "properties": {
        "fbom_location": {
          "type": "string",
          "description": "URL, file path, or registry reference"
        },
        "fbom_version": {
          "type": "string",
          "description": "Version of the external FBOM"
        },
        "resolution_type": {
          "type": "string",
          "enum": ["url", "file", "registry", "computed"],
          "description": "How dependency FBOM was resolved"
        },
        "checksum_sha256": {
          "type": "string",
          "pattern": "^[a-fA-F0-9]{64}$",
          "description": "SHA256 checksum (optional)"
        },
        "last_verified": {
          "type": "string",
          "format": "date-time",
          "description": "Last verification timestamp (optional)"
        },
        "spdx_document_id": {
          "type": "string",
          "pattern": "^SPDXRef-[A-Za-z0-9.-]+$",
          "description": "SPDX identifier for dependency FBOM"
        }
      }
    },
    "dependency_cluster": {
      "type": "object",
      "required": ["name", "entry_points"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Dependency package name"
        },
        "entry_points": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/dependency_entry"
          },
          "description": "Entry points from user code to this dependency"
        },
        "attack_paths": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/attack_path"
          },
          "description": "Hierarchical attack paths with vulnerability mapping"
        },
        "blast_radius_summary": {
          "$ref": "#/$defs/blast_radius_summary",
          "description": "High-level attack surface statistics"
        },
        "cluster_functions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "All reachable functions within this dependency (deprecated, use attack_paths)"
        },
        "total_blast_radius": {
          "type": "integer",
          "minimum": 0,
          "description": "Total count of cluster_functions (deprecated)"
        }
      }
    },
    "dependency_entry": {
      "type": "object",
      "required": ["function", "called_from"],
      "properties": {
        "function": {
          "type": "string",
          "description": "Function name in the dependency"
        },
        "called_from": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "User-defined functions that call this function"
        }
      }
    },
    "attack_path": {
      "type": "object",
      "required": ["entry_function", "path_depth", "risk_level", "vulnerability_ids", "path"],
      "properties": {
        "entry_function": {
          "type": "string",
          "description": "Starting function in the attack path"
        },
        "path_depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Depth of the attack path"
        },
        "risk_level": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"],
          "description": "Risk level classification"
        },
        "vulnerability_ids": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "CVE IDs associated with this path"
        },
        "path": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/path_step"
          },
          "description": "Array of PathStep objects"
        }
      }
    },
    "path_step": {
      "type": "object",
      "required": ["function", "package", "call_type"],
      "properties": {
        "function": {
          "type": "string",
          "description": "Function name"
        },
        "package": {
          "type": "string",
          "description": "Package containing the function"
        },
        "call_type": {
          "type": "string",
          "enum": ["direct", "transitive", "reflection"],
          "description": "Type of function call"
        },
        "risk_indicators": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["REFLECTION", "DESERIALIZATION", "NETWORK"]
          },
          "description": "Risk patterns identified in this step"
        }
      }
    },
    "blast_radius_summary": {
      "type": "object",
      "required": ["direct_functions", "transitive_functions", "high_risk_paths", "packages_reached", "max_path_depth"],
      "properties": {
        "direct_functions": {
          "type": "integer",
          "minimum": 0,
          "description": "Functions directly called by user code"
        },
        "transitive_functions": {
          "type": "integer",
          "minimum": 0,
          "description": "Functions reachable through transitive calls"
        },
        "high_risk_paths": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of high or critical risk attack paths"
        },
        "packages_reached": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of unique packages in attack paths"
        },
        "max_path_depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum depth of any attack path"
        }
      }
    },
    "entry_point": {
      "type": "object",
      "required": ["spdx_id", "name", "type", "package", "accessible_from", "security_level", "reachable_functions"],
      "properties": {
        "spdx_id": {
          "type": "string",
          "description": "SPDX identifier for the entry point"
        },
        "name": {
          "type": "string",
          "description": "Entry point function name"
        },
        "type": {
          "type": "string",
          "enum": ["main", "init", "internal"],
          "description": "Type of entry point"
        },
        "package": {
          "type": "string",
          "description": "Package containing the entry point"
        },
        "accessible_from": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["external", "internal"]
          },
          "description": "Accessibility levels"
        },
        "security_level": {
          "type": "string",
          "enum": ["public", "internal"],
          "description": "Security classification"
        },
        "reachable_functions": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of functions reachable from this entry point"
        }
      }
    },
    "call_graph": {
      "type": "object",
      "required": ["call_edges", "statistics"],
      "properties": {
        "call_edges": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/call_edge"
          }
        },
        "statistics": {
          "$ref": "#/$defs/call_graph_statistics"
        }
      }
    },
    "call_edge": {
      "type": "object",
      "required": ["caller", "callee", "call_type", "file_path", "line_number"],
      "properties": {
        "caller": {
          "type": "string"
        },
        "callee": {
          "type": "string"
        },
        "call_type": {
          "type": "string",
          "enum": ["internal", "external", "stdlib", "reflection"]
        },
        "file_path": {
          "type": "string"
        },
        "line_number": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "call_graph_statistics": {
      "type": "object",
      "required": [
        "total_nodes",
        "total_edges", 
        "max_depth",
        "average_depth",
        "cyclic_dependencies",
        "unreachable_functions"
      ],
      "properties": {
        "total_nodes": {
          "type": "integer",
          "minimum": 0
        },
        "total_edges": {
          "type": "integer",
          "minimum": 0
        },
        "max_depth": {
          "type": "integer",
          "minimum": 0
        },
        "average_depth": {
          "type": "number",
          "minimum": 0
        },
        "cyclic_dependencies": {
          "type": "integer",
          "minimum": 0
        },
        "unreachable_functions": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "security_info": {
      "type": "object",
      "required": [
        "total_cves_found",
        "critical_cves",
        "high_cves",
        "medium_cves", 
        "low_cves",
        "reflection_calls_count",
        "total_external_dependencies",
        "total_reachable_cves",
        "reachable_vulnerabilities",
        "unreachable_vulnerabilities",
        "vulnerable_functions",
        "analysis_timestamp"
      ],
      "properties": {
        "total_cves_found": {
          "type": "integer",
          "minimum": 0
        },
        "critical_cves": {
          "type": "integer",
          "minimum": 0
        },
        "high_cves": {
          "type": "integer",
          "minimum": 0
        },
        "medium_cves": {
          "type": "integer",
          "minimum": 0
        },
        "low_cves": {
          "type": "integer",
          "minimum": 0
        },
        "reflection_calls_count": {
          "type": "integer",
          "minimum": 0
        },
        "total_external_dependencies": {
          "type": "integer",
          "minimum": 0
        },
        "total_reachable_cves": {
          "type": "integer",
          "minimum": 0
        },
        "reachable_vulnerabilities": {
          "type": "integer",
          "minimum": 0
        },
        "unreachable_vulnerabilities": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "vulnerable_functions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/vulnerable_function"
          }
        },
        "analysis_timestamp": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "vulnerable_function": {
      "type": "object",
      "required": ["function_id", "full_name", "cves", "reachability_paths", "risk_score", "impact"],
      "properties": {
        "function_id": {
          "type": "string",
          "description": "Vulnerable function name"
        },
        "full_name": {
          "type": "string",
          "description": "Full function identifier for clarity when available"
        },
        "cves": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of CVE IDs affecting this function"
        },
        "reachability_paths": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Entry points that can reach this function"
        },
        "risk_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 10,
          "description": "Calculated risk score (0-10)"
        },
        "impact": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low"],
          "description": "Impact level classification"
        }
      }
    },
    "reflection_analysis": {
      "type": "object",
      "properties": {
        "summary": {
          "$ref": "#/$defs/reflection_summary"
        },
        "user_reflection_functions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/user_reflection_function"
          }
        },
        "vulnerability_exposure": {
          "$ref": "#/$defs/reflection_vulnerability_exposure"
        },
        "attack_chains": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/reflection_attack_chain"
          }
        },
        "detailed_targets": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/reflection_target"
          }
        }
      }
    },
    "reflection_summary": {
      "type": "object",
      "properties": {
        "total_user_reflection_functions": {
          "type": "integer",
          "minimum": 0
        },
        "total_vulnerable_targets": {
          "type": "integer",
          "minimum": 0
        },
        "highest_risk_level": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        },
        "total_attack_chains": {
          "type": "integer",
          "minimum": 0
        },
        "mitigation_priority": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "recommendations": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "user_reflection_function": {
      "type": "object",
      "properties": {
        "function_name": {
          "type": "string"
        },
        "package": {
          "type": "string"
        },
        "reflection_methods": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "risk_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10
        },
        "complexity": {
          "type": "string",
          "enum": ["direct", "layered", "dynamic"]
        },
        "entry_point": {
          "type": "string"
        },
        "vulnerable_targets_count": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "reflection_vulnerability_exposure": {
      "type": "object",
      "properties": {
        "cve_mapping": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "total_exposed_cves": {
          "type": "integer",
          "minimum": 0
        },
        "high_risk_functions": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "reflection_attack_chain": {
      "type": "object",
      "properties": {
        "chain_id": {
          "type": "string"
        },
        "source_function": {
          "type": "string"
        },
        "target_function": {
          "type": "string"
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/attack_chain_step"
          }
        },
        "layer_count": {
          "type": "integer",
          "minimum": 1
        },
        "complexity": {
          "type": "string",
          "enum": ["direct", "layered", "dynamic"]
        },
        "cves_exposed": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "attack_chain_step": {
      "type": "object",
      "properties": {
        "step_number": {
          "type": "integer",
          "minimum": 1
        },
        "function": {
          "type": "string"
        },
        "operation": {
          "type": "string"
        },
        "mechanism": {
          "type": "string",
          "enum": ["direct_call", "reflection", "interface_call", "dynamic_dispatch"]
        }
      }
    },
    "reflection_target": {
      "type": "object",
      "properties": {
        "target_package": {
          "type": "string"
        },
        "target_function": {
          "type": "string"
        },
        "reflection_callers": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "risk_level": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        },
        "potential_cves": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}
